<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Страхование</title>
    <link rel="stylesheet" href="/static/styles/main.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="non_func_header">
        <div class="img_name">
            <a href="/">
                <img src="/static/images/BIV.png" alt="" width="60px">
            </a>
            <p>Platform: Страхование</p>
        </div>
        <div class="log_in_out">
            <a href="/account">
                <img src="/static/images/account_grey.png" alt="Account" width="40px" style="border-radius: 50%;">
            </a>
            <i class="fas fa-profile"></i>
            <i class="fas fa-sign-out"></i>
        </div>
    </div>
    

    <div class="main-container">
        <div class="card">
            <h1 class="text-center mb-4">Страхование</h1>
            <form>
                <!-- Тип страхования -->
                <div class="mb-3">
                    <label for="insuranceTypeSelect" class="form-label">Тип страхования</label>
                    <select class="form-select" id="insuranceTypeSelect" required onchange="updateProductDropdown()">
                        <option value="" selected disabled>Выберите тип страхования</option>
                        {% for insurance_type in insurance_types %}
                        <option value="{{ insurance_type }}">{{ insurance_type }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Страховой продукт -->
                <div class="mb-3" id="productContainer" style="display: none;">
                    <label for="productSelect" class="form-label">Страховой продукт</label>
                    <select class="form-select" id="productSelect" required>
                        <option value="" selected disabled>Выберите продукт</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary w-100" onclick="redirectToNewContract()">Застраховать</button>
            </form>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>BIV Hack by "MISIS Leaf Lovers"</p>
            <p>Все права защищены</p>
            <p><a href="#">Политика конфиденциальности</a> | <a href="#">Условия использования</a></p>
        </div>
    </footer>

    <script>
        // Function to update the "Страховой продукт" dropdown
        async function updateProductDropdown() {
            // Perform a POST request to the current page URL
            const response = await fetch(window.location.href, { 
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            });

            // Parse the JSON response
            const productOptions = await response.json();

            // Log the product options for debugging
            console.log(productOptions);
            const insuranceType = document.getElementById("insuranceTypeSelect").value;
            const productSelect = document.getElementById("productSelect");
            const productContainer = document.getElementById("productContainer");

            // Clear existing options
            productSelect.innerHTML = '<option value="" selected disabled>Выберите продукт</option>';

            // Populate options based on the selected type
            if (productOptions[insuranceType]) {
                productOptions[insuranceType].forEach(product => {
                    const option = document.createElement("option");
                    option.value = product[1];
                    option.textContent = product[1];
                    option.id = product[0]
                    productSelect.appendChild(option);
                });

                // Show the product dropdown
                productContainer.style.display = "block";
            } else {
                // Hide the product dropdown if no valid type is selected
                productContainer.style.display = "none";
            }
        }

        function redirectToNewContract() {
            // Get selected insurance type and product
            const insuranceType = document.getElementById("insuranceTypeSelect").value;
            const productSelect = document.getElementById("productSelect").value;
            const newid = document.getElementById('productSelect');

            // Ensure both fields are selected before proceeding
            if (!insuranceType || !productSelect) {
                alert("Пожалуйста, выберите тип страхования и продукт.");
                return;
            }

            // Construct the URL with query parameters
            const url = `/new_contract?id=${encodeURIComponent(newid.options[newid.selectedIndex].id)}`;

            // Redirect to the new page
            window.location.href = url;
        }
    </script>
</body>
</html>